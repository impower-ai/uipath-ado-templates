#presumes the existence of a repository resource named 'target' with a project.json in the root directory
#presumes the existence of a repository resource named 'impower' with relevant scripts
parameters:
  - name: service_connection
    type: string
  - name: azure_environment
    type: string
  - name: orchestrator_folder
    type: string
  - name: trace_level
    type: string
    default: 'Warning'
  - name: stage_name
    type: string
  - name: stage_dependencies
    type: object
    default: []
  - name: main_only
    type: boolean
    default: false

stages:
- stage: ${{ parameters.stage_name }}
  displayName: ${{ replace(parameters.stage_name,'_',' ') }}
  dependsOn: '${{ parameters.stage_dependencies }}'
  ${{ if parameters.main_only }}:
    condition: and(eq(variables['Build.SourceBranchName'], 'main'),not(contains(join(';',dependencies.*.result),'Failed')))
  ${{ if not(parameters.main_only) }}:
    condition: not(contains(join(';',dependencies.*.result),'Failed'))
  jobs:
  - deployment: Deploy_${{ parameters.stage_name }}
    displayName: ${{ replace(parameters.stage_name,'_',' ') }}
    pool:
      vmImage: 'windows-latest'
    environment: ${{ parameters.azure_environment }}
    strategy:
      runOnce:
        deploy:
          steps:
          - script: 'echo $[join(';',stageDependencies.*.result)]'
          - task: UiPathDeploy@2
            inputs:
              orchestratorConnection: ${{ parameters.service_connection }}
              packagesPath: $(Pipeline.Workspace)/UiPathPackage
              folderName: ${{ parameters.orchestrator_folder }}
              traceLevel: ${{ parameters.trace_level }}
          
      
